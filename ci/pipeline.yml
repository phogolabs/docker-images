---
groups:
  - name: docker-images
    jobs:
    - patch
    - minor
    - major
    - build-rc
    - promote

jobs:
  - name: build-rc
    public: true
    serial: true
    plan:
      - get: docker-file
        trigger: true
      - put: version
        params: {pre: rc}
      - put: docker-image-rc
        resource: docker-image
        params:
         build: {{docker-file-path}}
         tag: version/number

  - name: promote
    public: true
    serial: true
    plan:
      - get: docker-image
        params:
         save: true
         tag: version/number
        trigger: false
        passed: [build-rc]
      - get: version
        params: {bump: final}
        passed: [build-rc]
      - put: docker-image-final
        resource: docker-image
        params:
         load: docker-image
         tag: version/number
         tag_as_latest: true

  - name: patch
    public: true
    plan:
      - get: version
        trigger: false
        params: {bump: patch}
      - put: version
        params: {file: version/number}

  - name: minor
    public: true
    plan:
      - get: version
        trigger: false
        params: {bump: minor}
      - put: version
        params: {file: version/number}

  - name: major
    public: true
    plan:
      - get: version
        trigger: false
        params: {bump: minor}
      - put: version
        params: {file: version/number}

resources:
  - name: docker-file
    type: git
    source:
      uri: git@github.com:phogolabs/docker-images.git
      branch: master
      private_key: {{github-private-key}}

  - name: version
    type: semver
    source:
      driver: git
      git_user: {{git-bot-user}}
      initial_version: 0.0.1
      uri: git@github.com:phogolabs/docker-images.git
      private_key: {{github-private-key}}
      branch: version
      file: {{docker-image-version-file}}

  - name: docker-image
    type: docker-image
    source:
      email: {{dockerhub-email}}
      username: {{dockerhub-username}}
      password: {{dockerhub-password}}
      repository: {{dockerhub-image}}
